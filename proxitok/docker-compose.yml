version: '3'
networks:
  default:
    enable_ipv6: true
  web:
    external: true

services:
  proxitok:
    container_name: proxitok
    image: ghcr.io/pablouser1/proxitok:master@sha256:9300a54e10314e1fb8b3c2056705d6a931ce979d92793fd972c37ded446ece60
    restart: always
#    ports:
#      - 8080:8080
    environment:
      - LATTE_CACHE=/cache
      - API_CACHE=redis
      - REDIS_HOST=proxitok-redis
      - REDIS_PORT=6379
      - API_CHROMEDRIVER=http://proxitok-chromedriver:9515
    volumes:
      - proxitok-cache:/cache
    depends_on:
      - redis
    networks:
      default:
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  redis:
    container_name: proxitok-redis
    image: redis:7-alpine@sha256:f773b35a95e170d92dd4214a3ec4859b1b7960bf56896ae687646d695f311187
    command: redis-server --save 60 1 --loglevel warning
    restart: always
    user: nobody
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /data:size=10M,mode=0770,uid=65534,gid=65534,noexec,nosuid,nodev
    cap_drop:
      - ALL

  chromedriver:
    container_name: proxitok-chromedriver
    image: zenika/alpine-chrome:with-chromedriver
    init: true
    restart: always
    shm_size: 1g
    networks:
      - default
    security_opt:
      - seccomp:./misc/setup/docker/chrome.json

  anubis:
    container_name: anubis-proxitok
    image: ghcr.io/techarohq/anubis:latest@sha256:4836f8b86a185f7be92e8c76bf03de73ce9ec793b61a27473a72c41811d07cd5
    environment:
      BIND: ":8923"
      DIFFICULTY: "3"
      METRICS_BIND: ":9090"
      SERVE_ROBOTS_TXT: "false"
      TARGET: "http://proxitok:8080"
    volumes:
      - /home/ubuntu/anubis/botPolicy.json:/data/cfg/botPolicy.json:ro
    user: "1000:1000"
    restart: always
    networks:
      - web
      - default
    depends_on:
      - proxitok

volumes:
  proxitok-cache:
